<html><head>
  <script type="text/javascript" src="akihabara/gbox.js"></script>
  <script type="text/javascript" src="akihabara/iphopad.js"></script>
  <script type="text/javascript" src="akihabara/trigo.js"></script>
  <script type="text/javascript" src="akihabara/toys.js"></script>
  <script type="text/javascript" src="akihabara/help.js"></script>
  <script type="text/javascript" src="akihabara/tool.js"></script>
  <script type="text/javascript" src="akihabara/gamecycle.js"></script>
  <style>BODY { -webkit-user-select:none; margin:0px}</style>
  <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;" />
  <script type="text/javascript" src="lib/global.js"></script>
  <script type="text/javascript" src="actors/cap_man.js"></script>
<script type="text/javascript" charset="utf-8">
var maingame; // The magic object that handles the full play cycle
var maze; // The maze array, with pills and walls

window.addEventListener('load', loadResources, false);

function loadResources() {
  help.akihabaraInit("The Forest"); // Akihabara is initialized with title and all the default settings.

  gbox.setCallback(main); // the "go" method is registerd as callback: when all the resources are loaded, will be called.

  gbox.addImage("font","resources/capman/font.png"); // ...or font set.

  gbox.addImage("logo","resources/forest/logo3.png");

  gbox.addImage("cels","resources/capman/cels.png");

  gbox.addImage("maze_cels","resources/forest/maze_cels.png");

  // Sprites sheets are cut here, setting the tile size, the number of sprites per row and the gap of the frames set.
  gbox.addTiles({ id: 'capman',      image: 'cels',      tileh: 12,  tilew: 12,  tilerow: 10, gapx: 0,    gapy: 0  });

  gbox.addTiles({ id: 'maze',        image: 'maze_cels', tileh: 4,   tilew: 4,   tilerow: 13, gapx: 0,    gapy: 0  }); // The tilesets are taken from the sprite sheet too.

  gbox.addFont({id:'small',image:'font',firstletter:' ',tileh:8,tilew:8,tilerow:255,gapx:0,gapy:0}); // Font are mapped over an image, setting the first letter, the letter size, the length of all rows of letters and a horizontal/vertical gap.

  gbox.loadAll(); // When everything is ready, the "loadAll" downloads all the needed resources.
}

function main() {
  // The very first thing to do is to set which groups will be involved in the game. Groups can be used for grouped collision detection and for rendering order
  gbox.setGroups(["background","player","gamecycle"]); // Usually the background is the last thing rendered. The last thing is "gamecycle", that means games messages, like "gameover", menus etc.

  maingame = gamecycle.createMaingame("gamecycle","gamecycle"); // We create a new maingame into the "gamecycle" group. Will be called "gamecycle". From now, we've to "override" some of the maingame default actions.

  maingame.gameMenu=function() { return true; }

  // Disable the default "get ready" screen; we don't need it for our tutorial
  maingame.gameIntroAnimation = function() { return true; };

  // Last but not least, the intro screen.
  // As you've seen, there are a bunch of method that are called by the "maingame" during the game life.
  // We've used the default behaviour for most of them (the "let's begin" message, the "gameover" screen etc.)
  //  but all of them are customizable. In this case, we're going to create a custom intro screen.
  maingame.gameTitleIntroAnimation = function(reset) {
    if (reset) { // "reset" is true before the first frame of the intro screen. We can prepare the intro animation...
      toys.resetToy(this, 'rising'); // Like resetting a local toy. Some of the toys are "helpers": they use a local datastore of an object and does stuff, when called. For example: we're reserving a data store called "rising" to the "maingame" object.
    } else { // Then, when is the time to render our animation...
      gbox.blitFade(gbox.getBufferContext(), { alpha: 1 }); // First clear up the screen...
      //toys.logos.linear(this,"rising",{image:"logo",x:gbox.getScreenHW()-gbox.getImage("logo").hwidth,y:20,sx:gbox.getScreenHW()-gbox.getImage("logo").hwidth,sy:gbox.getScreenH(),speed:3}); // Then we're telling to the "linear" toy (which renders something that moves from a point to another) to use the "rising" data store, for keeping his values.
      toys.logos.crossed(this, 'crosser', {
        image: 'logo',
        x: gbox.getScreenHW() - gbox.getImage('logo').hwidth,
        y: 20,
        speed: 2,
        gapx: 250,
        alpha: 0.5
      });
    }
  };

   // This method is called every new level. That is called also for the first level, so...
  maingame.changeLevel=function(level) {
      // The first time the "changeLevel" is called, level is NULL. Our first stage is "1", so...
      if (level==null) level=1;
      // We need to store this number somewhere, since is needed to define which is the next level.
      maingame.level=level; // "maingame" is handy enough to store some game data.

    // Let's prepare the maze map now. Every stage is the same level but you can generate a new level each "changeLevel" call, using the "level" argument value.
    // This is just an array with the tile id or NULL for an empty transparent space.
    maze=help.finalizeTilemap({ // finalizeTilemap does some magic to the maze object: calculate real width/height of the map in pixels and values the "h" and "w" property.
      tileset: 'maze',
      map:load_map('1'),            // ...this array as palette. Don't you think that a map like this is quite easy to edit and read with your on-the-go text editor?
      tileIsSolid:function(obj,t) { // This function have to return true if the object "obj" is checking if the tile "t" is a wall, so...
        return (t!==null) &&        // Is a wall if is not an empty space and...
          ((t<6) ||                 // Is a piece of wall or...
          ((t==6) && (obj.status!="goout") && (obj.status!="goin"))); // The ghost's door (only if is not a ghost that is trying to go out or in)
      }
    });

    gbox.createCanvas('mazecanvas', { w: maze.w, h: maze.h }); // Since finalizeMap have calculated the real height and width, we can create a canvas that fits perfectly our maze... Let's call it "mazecanvas".
    gbox.blitTilemap(gbox.getCanvasContext("mazecanvas"),maze); // Let's paste the maze map in the "maze" object into the just created "mazecanvas". So is now ready to be rendered.

    this.newLife(); // We will call the local "newLife" method, since this came displaces enemies and player every new level. Do you remember this in capman? ;)
  }

  // This event is triggered every time the player "reborn". As you've seen, is manually called in the last line of "changelevel"
  maingame.newLife=function(up) {
    gbox.purgeGarbage(); // the gbox module have a garbage collector that runs sometime. Let's call this manually, for optimization (and better reinitialization)
    toys.topview.spawn(gbox.getObject("player","capman"),{x:maze.hw-6,y:maze.hh+50,accx:0,accy:0,xpushing:false,ypushing:false}); // Our "capman" object into the "player" group spawns in the middle of the maze every time it spawns.
  }

  // This method is called before starting the game, after the startup menu. Everything vital is done here, once per play.
  maingame.initializeGame=function() {

    // An object will draw the maze on the screen
    gbox.addObject({
      id: 'bg', // This is the object ID
      group: 'background', // Is in the "backround" group, that is the lower group in the "setGroups" list. Will be drawn for first.
      initialize: function() { // This action is executed the first time the object is called, so...
        gbox.setCameraY(2,{w:maze.w,h:maze.h}); // We place the camera a bit down, since the full maze doesn't fit the screen.
      },
      blit:function() { // Then, the most important action: the "blit", where object are drawn on the screen.
        gbox.blitFade(gbox.getBufferContext(),{alpha:1}); // First let's clear the whole screen. Blitfade draws a filled rectangle over the given context (in this case, the screen)
        gbox.blit(gbox.getBufferContext(),gbox.getCanvas("mazecanvas"),{dx:0,dy:0,dw:gbox.getCanvas("mazecanvas").width,dh:gbox.getCanvas("mazecanvas").height,sourcecamera:true}); // Simply draw the maze on the screen.
      },
    });

    // Now, let's add our capman. The player is usually added once per match and "moved" in the map on level changes (as you've seen into the newLife method)
    gbox.addObject(CAP_MAN);
  }

  // That's all. Please, gamebox... run the game!
  gbox.go();
}

function load_map(level_name) { return help.asciiArtToMap([
"T----------------------------------------------------------------------------------------------------------------T",
"||T----------------------------------------------------TxxT----------------------------------------------------T||",
"||||                                                  ||xx||                                                  ||||",
"||||                                                  ||xx||                                                  ||||",
"||||                                                  ||xx||                                                  ||||",
"||L--------------------------------------------T      ||xx||      T--------------------------------------------J||",
"||xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx||      ||xx||      ||xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx||",
"||xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx||      ||xx||      ||xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx||",
"||xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx||      ||xx||      ||xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx||",
"||T--------------------------------------------J      ||xx||      L--------------------------------------------T||",
"||||                                                  ||xx||                                                  ||||",
"||||                                                  ||xx||                                                  ||||",
"||||                                                  ||xx||                                                  ||||",
"||||      T--------------------------------------------JxxL--------------------------------------------T      ||||",
"||||      ||xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx||      ||||",
"||||      L--------------------------------------------------------------------------------------------J      ||||",
"||||                                                                                                          ||||",
"||||                                                                                                          ||||",
"||||                                                                                                          ||||",
"||L------------------------------------------------------------------------------------------------------------J||",
"L----------------------------------------------------------------------------------------------------------------J",
"                                                                                                                  ",
"                                                                                                                  ",
"                                                                                                                  ",
"                                                                                                                  ",
"                                                                                                                  ",
"                                                                                                                  ",
"                                                                                                                  ",
"                                                                                                                  ",
"                                                                                                                  ",
"                                                                                                                  ",
"                                                                                                                  ",
"                                                                                                                  ",
"                                                                                                                  ",
"                                                                                                                  ",
"                                                                                                                  ",
"T----------------------------------------------------------------------------------------------------------------T",
"||T----------------------------------------------------TxxT----------------------------------------------------T||",
"||||                                                  ||xx||                                                  ||||",
"||||  >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>  ||xx||  >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>  ||||",
"||||  >>                  >>                      >>  ||xx||  >>                      >>                  >>  ||||",
"||||  >>  T------------T  >>  T----------------T  >>  ||xx||  >>  T----------------T  >>  T------------T  >>  ||||",
"||||  >>  ||xxxxxxxxxx||  >>  ||xxxxxxxxxxxxxx||  >>  ||xx||  >>  ||xxxxxxxxxxxxxx||  >>  ||xxxxxxxxxx||  >>  ||||",
"||||  >>  L--------Txx||  >>  L----------------J  >>  L----J  >>  L----------------J  >>  ||xxT--------J  >>  ||||",
"||||  >>          ||xx||  >>                      >>          >>                      >>  ||xx||          >>  ||||",
"||||  >>>>>>>>>>  ||xx||  >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>  ||xx||  >>>>>>>>>>  ||||",
"||||          >>  ||xx||  >>          >>                                  >>          >>  ||xx||  >>          ||||",
"||L--------T  >>  ||xx||  >>  T----T  >>  T----------------------------T  >>  T----T  >>  ||xx||  >>  T--------J||",
"||xxxxxxxx||  >>  ||xx||  >>  ||xx||  >>  ||xxxxxxxxxxxxxxxxxxxxxxxxxx||  BB  ||xx||  >>  ||xx||  >>  ||xxxxxxxx||",
"||T--------J  >>  L----J  >>  ||xx||  >>  L------------TxxT------------J  BB  ||xx||  >>  L----J  >>  L--------T||",
"||||          >>          >>  ||xx||  >>              ||xx||              BB  ||xx||  >>          >>          ||||",
"||||  >>>>>>>>>>>>>>>>>>>>>>  ||xx||  >>>>>>>>>>>>>>  ||xx||  BBBBBBBBBBBBBB  ||xx||  >>>>>>>>>>>>>>>>>>>>>>  ||||",
"||||  >>                      ||xx||              >>  L----J  BB              ||xx||                      >>  ||||",
"||||  >>  T--------------------JxxL------------T  >>          BB  T------------JxxL--------------------T  >>  ||||",
"||||  >>  ||xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx||  >>          BB  ||xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx||  >>  ||||",
"||||  >>  L------------------------------------J  >>          BB  L------------------------------------J  >>  ||||",
"||||  >>                                          >>  T----T  BB                                              ||||",
"||||  >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>  ||xx||  BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB  ||||",
"||||                                                  ||xx||                                                  ||||",
"||L----------------------------------------------------JxxL----------------------------------------------------J||",
"L----------------------------------------------------------------------------------------------------------------J",

],[[null,"  "],[0,"||"],[1,"--"],[2,"L-"],[3,"-J"],[4,"T-"],[5,"-T"],[6,"~~"],[7,"xx"],[8," ."],[9," o"],[10, "=="],[12, "BB"],[10, ">>"]]) }
</script>
</head><body></body></html>